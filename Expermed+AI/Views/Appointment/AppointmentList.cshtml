@model List<Appointment>
@{
    ViewBag.Title = "Appointment List";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var successMessage = TempData["SuccessMessage"] as string;
    var errorMessage = TempData["ErrorMessage"] as string;
}

@section styles {
        <link rel="stylesheet" href="https://cdn.datatables.net/1.11.5/css/dataTables.bootstrap5.min.css" />
        <link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.2.9/css/responsive.bootstrap.min.css" />
        <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.2.2/css/buttons.dataTables.min.css">
}

<div class="row">
    <div class="col-lg-12">
        @if (TempData["Error"] != null)
        {
                <div class="alert alert-danger">
                @TempData["Error"]
                </div>
        }

        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Appointment List</h5>
                <div class="btn-group mt-3" role="group">
                    <button type="button" class="btn btn-soft-success @(ViewBag.CurrentStatus == 0 ? "active" : "")" 
                            onclick="filterAppointments(0)">Paid</button>
                    <button type="button" class="btn btn-soft-warning @(ViewBag.CurrentStatus == 1 ? "active" : "")" 
                            onclick="filterAppointments(1)">Active</button>
                    <button type="button" class="btn btn-soft-danger @(ViewBag.CurrentStatus == 2 ? "active" : "")" 
                            onclick="filterAppointments(2)">Canceled</button>
                    <button type="button" class="btn btn-soft-info @(ViewBag.CurrentStatus == 3 ? "active" : "")" 
                            onclick="filterAppointments(3)">Follow-up</button>
                </div>
            </div>
            <div class="card-body">
                <table id="appointmentTable" class="table nowrap dt-responsive align-middle table-hover table-bordered">
                    <thead>
                        <tr>
                            <th hidden>ID</th>
                            <th>Date of Appointment</th>
                            <th>Patient Name</th>
                            <th>Specialty Appointment</th>
                            <th>Status of Appointment</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var appointment in Model)
                        {
                                <tr>
                                    <td hidden>@appointment.AppointmentId</td>
                                    <td>@appointment.AppointmentDate.ToString("dd/MM/yyyy") @appointment.AppointmentHour.ToString()</td>
                                    <td>@($"{appointment.AppointmentPatient?.PatientFirstname} {appointment.AppointmentPatient?.PatientMiddlename} {appointment.AppointmentPatient?.PatientFirstsurname} {appointment.AppointmentPatient?.PatientSecondlastname}")</td>
                                    <td>@appointment.AppointmentCreateuserNavigation?.UserSpecialty?.SpecialityName</td>
                                    <td>
                                    @{
                                        var (statusClass, statusText) = appointment.AppointmentStatus switch
                                        {
                                            0 => ("bg-success", "Paid"),
                                            1 => ("bg-warning", "Active"),
                                            2 => ("bg-danger", "Canceled"),
                                            3 => ("bg-info", "Follow-up"),
                                            _ => ("bg-secondary", "Unknown")
                                        };
                                    }
                                        <span class="badge @statusClass">@statusText</span>
                                    </td>
                                   <td>
                                        @if (appointment.AppointmentStatus == 0 || appointment.AppointmentStatus == 2) 
                                        {
                                            <!-- Si la cita está pagada o cancelada, deshabilitar el botón -->
                                            <span class="btn btn-sm btn-soft-secondary" style="pointer-events: none;">
                                                <i class="ri-edit-line"></i> Review
                                            </span>
                                        }
                                        else
                                        {
                                            <!-- Si la cita está activa o en seguimiento, mostrar el botón -->
                                            <a href="@Url.Action("Review", "Appointment", new { id = appointment.AppointmentId })" 
                                               class="btn btn-sm btn-soft-info">
                                                <i class="ri-edit-line"></i> Review
                                            </a>
                                        }
                                    </td>

                                </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

@section scripts {
            <script src="https://code.jquery.com/jquery-3.6.0.min.js"
                integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

            <!--datatable js-->
            <script src="https://cdn.datatables.net/1.11.5/js/jquery.dataTables.min.js"></script>
            <script src="https://cdn.datatables.net/1.11.5/js/dataTables.bootstrap5.min.js"></script>
            <script src="https://cdn.datatables.net/responsive/2.2.9/js/dataTables.responsive.min.js"></script>
            <script src="https://cdn.datatables.net/buttons/2.2.2/js/dataTables.buttons.min.js"></script>
            <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.print.min.js"></script>
            <script src="https://cdn.datatables.net/buttons/2.2.2/js/buttons.html5.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>

            <script src="~/assets/js/pages/datatables.init.js"></script>

            <!-- App js -->
            <script src="~/assets/js/app.js"></script>
        <script>
            $(document).ready(function() {
                $('#appointmentTable').DataTable({
                    responsive: true,
                    pageLength: 10,
                    order: [[1, 'desc']]
                });
            });

            function filterAppointments(status) {
                        window.location.href = '@Url.Action("AppointmentList", "Appointment")?' + new URLSearchParams({
                    appointmentStatus: status,
                    userProfile: '@ViewBag.UserProfile',
                    userId: '@ViewBag.UserId',
                    doctorId: '@(ViewBag.DoctorId ?? "null")'
                }).toString();
            }
        </script>
}